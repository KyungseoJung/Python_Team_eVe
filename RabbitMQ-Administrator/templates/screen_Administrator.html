<!-- // T-Map appkey = 5RB8KXlDuB6uLZGhugCqS9OJMViZ73P93dRPbphu -->

<!-- 
//#26 관리자(Administrator) 웹화면 디자인 구성 
//#27 관리자 웹페이지 디자인 
//#28 수리모형 코드 통합 - [경로 계산하기] 버튼 누르면, 수리모형 코드 실행되도록 - csv 파일 지정한 파일 위치에 저장되도록
//#29 배터리 강화학습 코드 통합

-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 페이지</title>
    <!-- //#29 차트 보여주기 위해 필요 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* //#27 
      Body나 HTML 태그의 마진 또는 패딩: 기본적으로 브라우저는 HTML 페이지의 body 태그에 마진이나 패딩을 자동으로 추가하기 때문에 공백이 발생할 수 있음
      -> 이를 제거하려면 CSS에서 body와 html 태그의 마진과 패딩을 0으로 설정해야 함.
      불필요한 태그나 공백: HTML 코드 내에 불필요한 공백이나 태그가 있을 경우 이를 정리함. */
      html,
      body {
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial, sans-serif;
      }
      .navbar {
        /* //#27 불필요한 공백 제거 */
        margin-top: 0;
        padding-top: 0;

        background: #333;
        padding: 10px 40px;
        color: white;
        text-align: right;
      }
      .button {
        color: white;
        background: gray;
        padding: 10px 40px;
        border: none;
        cursor: pointer;
        margin-right: 10px;
        font-size: 17px; /* Larger font size */
      }
      .button.active {
        background: red;
      }
      /* [주문 관리] 페이지 화면 속 버튼 */
      .button-check {
        /* color: white;
        background: gray;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        margin-right: 10px; */

        color: black;
        background: #ffd8d8; /* Dark grey background */
        border: 1.5px solid #000000;
        padding: 10px 40px; /* Larger buttons */
        cursor: pointer;
        font-size: 20px; /* Larger font size */
        border-radius: 5px; /* Rounded corners */
      }
      .button-calculate {
        color: white;
        background: #000000; /* Dark grey background */
        border: 1.5px solid #ffffff;
        padding: 10px 20px; /* Larger buttons */
        cursor: pointer;
        font-size: 20px; /* Larger font size */
        border-radius: 5px; /* Rounded corners */
      }
      .button-save {
        color: white;
        background: #000000; /* Dark grey background */
        border: 1.5px solid #000000;
        padding: 10px 30px; /* Larger buttons */
        cursor: pointer;
        font-size: 20px; /* Larger font size */
        border-radius: 5px; /* Rounded corners */
      }
      #content {
        /* //#27 불필요한 공백 제거 */
        margin-top: 0;
        padding-top: 0;

        padding: 20px;
        display: flex;
        justify-content: space-around;
      }
      .panel {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 20px;
        width: 48%;
      }
      .section {
        display: none;
        flex: 1;
        margin: 0 10px;
        border: 1px solid #ccc;
        padding: 10px;
      }
      .visible {
        display: flex;
      }
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 8px;
      }
      .hidden {
        display: none;
      }
      .loader-container {
        display: flex;
        align-items: center;
        margin-top: 20px;
        margin-bottom: 20px;
        gap: 20px;
      }
      .loader {
        width: 100px;
        height: 20px;
        background: gray;
      }
      .loader-bar {
        height: 100%;
        background: lightgreen;
        width: 0%;
      }
      /* complete 됐을 때, 초록색으로 로딩바 가득 채우기 */
      .complete {
        background-color: green;
        width: 100% !important;
      }
      .disabled {
        pointer-events: none;
        opacity: 0.4;
      }
      /* #27 데이터 테이블 스크롤 가능하도록 */
      .table-container {
        overflow-y: auto;
        max-height: 400px;
      } /* Scrollable container */
      /* //#29 배터리 관리 페이지 - 차트 style 지정 */
      .chart-container {
        width: 400px;
        height: 400px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <button class="button active" onclick="showSection('order')">
        주문 관리
      </button>
      <button class="button" onclick="showSection('delivery')">
        배달 관리
      </button>
      <button class="button" onclick="showSection('battery')">
        배터리 관리
      </button>
    </div>
    <div id="content">
      <div id="order" class="section visible">
        <div class="panel">
          <h2>주문 데이터 확인</h2>
          <button class="button-check" onclick="loadCSVData()">
            <img
              src="https://cdn-icons-png.flaticon.com/128/9159/9159105.png"
              alt="Load Icon"
              style="
                height: 30px;
                width: 30px;
                vertical-align: middle;
                margin-right: 5px;
              "
            />

            Load CSV Data
          </button>
          <div class="table-container">
            <table id="data-table"></table>
          </div>
        </div>
        <div class="panel">
          <h2>경로 계산</h2>
          <button class="button-calculate" onclick="calculatePath()">
            <img
              src="https://cdn-icons-png.flaticon.com/128/9422/9422848.png"
              alt="Load Icon"
              style="
                height: 30px;
                width: 30px;
                vertical-align: middle;
                margin-right: 5px;
              "
            />
            경로 계산하기
          </button>
          <div class="loader-container hidden">
            <div class="loader">
              <div class="loader-bar"></div>
            </div>
            <!-- 로딩바 완료 메시지 -->
            <span id="completeLabel" class="hidden"
              >Complete! 파일 저장 완료</span
            >
          </div>
          <button class="button-save" onclick="saveFile()">
            <img
              src="https://cdn-icons-png.flaticon.com/128/2480/2480719.png"
              alt="Load Icon"
              style="
                height: 30px;
                width: 30px;
                vertical-align: middle;
                margin-right: 5px;
              "
            />
            파일 저장
          </button>
        </div>
      </div>
      <div id="delivery" class="section">
        <h2>구현 예정입니다~</h2>
      </div>
      <div id="battery" class="section">
        <!-- ============= //#29 배터리 강화학습 코드 통합 - 여기부터=============-->
        <h2>Battery State of Charge</h2>
        <div id="charts">
          <!-- 5 canvas elements for 5 charts -->
          <div class="chart-container">
            <canvas id="batteryChart0" width="400" height="400"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="batteryChart1" width="400" height="400"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="batteryChart2" width="400" height="400"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="batteryChart3" width="400" height="400"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="batteryChart4" width="400" height="400"></canvas>
          </div>
        </div>
        <!-- ============= //#29 배터리 강화학습 코드 통합 - 여기까지=============-->
      </div>
    </div>

    <script>
      //#27 경로 계산 전에는 버튼 비활성화 되어 있도록
      document.querySelectorAll(".button-check").forEach((btn) => {
        btn.classList.add("disabled");
      });
      document.querySelectorAll(".button-save").forEach((btn) => {
        btn.classList.add("disabled");
      });

      function showSection(section) {
        document.querySelectorAll(".section").forEach((sec) => {
          sec.classList.remove("visible");
        });
        document.querySelectorAll(".button").forEach((btn) => {
          btn.classList.remove("active");
          btn.disabled = false; // Enable all buttons
        });
        document.getElementById(section).classList.add("visible");
        document
          .querySelector(`.button[onclick="showSection('${section}')"]`)
          .classList.add("active");
      }

      function calculatePath() {
        disableButtons(); // 다른 버튼들 모두 비활성화

        const loaderContainer = document.querySelector(".loader-container");
        const loaderBar = document.querySelector(".loader-bar");
        const completeLabel = document.getElementById("completeLabel");
        loaderContainer.classList.remove("hidden");

        //#28 ======================= 수리모형 함수 넣기 -> 주석처리 여기부터
        loaderBar.style.width = "0%";
        let width = 0;
        const interval = setInterval(() => {
          if (width >= 100) {
            clearInterval(interval);
            alert("경로 계산 완료");
            // loaderBar.style.width = "0%";
            loaderBar.className = "loader-bar complete"; // 경로 계산 마침 - 계속 초록색으로 로딩바 채워져 있도록 (Complete!)
            completeLabel.classList.remove("hidden");
            loaderContainer.classList.add("hidden");
            enableButtons(); // 다른 버튼들 모두 활성화
          } else {
            width++;
            loaderBar.style.width = `${width}%`;
          }
        }, 10);
        //#28 ======================= 수리모형 함수 넣기 -> 주석처리 여기까지

        // fetch("/calculate_path", { method: "POST" }) // POST request -> Flask로 요청
        //   .then((response) => response.json())
        //   .then((data) => {
        //     if (data.success) {
        //       loaderBar.style.width = "100%"; // #28 로딩바 100% 채우기
        //       completeLabel.classList.remove("hidden");
        //       alert("경로 계산이 완료 + CSV 저장 완료");

        //       // 기존 코드 - 버튼 비활성화/ 활성화
        //       loaderBar.className = "loader-bar complete"; // 경로 계산 마침 - 계속 초록색으로 로딩바 채워져 있도록 (Complete!)
        //       completeLabel.classList.remove("hidden");
        //       loaderContainer.classList.add("hidden");
        //       enableButtons(); // 다른 버튼들 모두 활성화
        //     } else {
        //       alert("에러 발생: " + data.message);
        //     }
        //   })
        //   .catch((error) => {
        //     alert("통신 오류: " + error);
        //     console.log(error);
        //   })
        //   .finally(() => {
        //     loaderContainer.classList.add("hidden");
        //   });
      }

      function disableButtons() {
        document.querySelectorAll(".button").forEach((btn) => {
          btn.classList.add("disabled");
        });
        //#27 이미 비활성화 되어있음
        // document.querySelectorAll(".button-check").forEach((btn) => {
        //   btn.classList.add("disabled");
        // });
        document.querySelectorAll(".button-calculate").forEach((btn) => {
          btn.classList.add("disabled");
        });
        //#27 이미 비활성화 되어있음
        // document.querySelectorAll(".button-save").forEach((btn) => {
        //   btn.classList.add("disabled");
        // });
      }

      function enableButtons() {
        document.querySelectorAll(".button").forEach((btn) => {
          btn.classList.remove("disabled");
        });
        document.querySelectorAll(".button-check").forEach((btn) => {
          btn.classList.remove("disabled");
        });
        //#27
        // document.querySelectorAll(".button-calculate").forEach((btn) => {
        //   btn.classList.remove("disabled");
        // });
        document.querySelectorAll(".button-save").forEach((btn) => {
          btn.classList.remove("disabled");
        });
      }

      function saveFile() {
        alert("파일이 저장되었습니다!");
      }

      function loadCSVData() {
        fetch("/static/deliveries.csv")
          .then((response) => response.text())
          .then((data) => {
            const rows = data.split("\n").map((row) => row.split(","));
            const table = document.getElementById("data-table");
            table.innerHTML = ""; // Clear previous data
            rows.forEach((row, index) => {
              const tr = document.createElement("tr");
              row.forEach((cell) => {
                const td = document.createElement("td");
                td.textContent = cell;
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
          })
          .catch((error) => {
            alert("Error loading data: " + error);
          });
      }
      //  ============= //#29 [배터리 관리] 페이지 =============
      //  ============= //#29 배터리 강화학습 코드 통합 - 여기부터=============
      const chartCount = 5;
      const charts = [];

      function createDoughnutChart(ctx) {
        return new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["State of Charge", "Remaining"],
            datasets: [
              {
                data: [0, 100],
                backgroundColor: ["#36A2EB", "#FFCE56"],
                hoverBackgroundColor: ["#36A2EB", "#FFCE56"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function (tooltipItem) {
                    return `${tooltipItem.label}: ${tooltipItem.raw}%`;
                  },
                },
              },
            },
          },
        });
      }

      for (let i = 0; i < chartCount; i++) {
        const ctx = document
          .getElementById(`batteryChart${i}`)
          .getContext("2d");
        charts.push(createDoughnutChart(ctx));
      }

      function updateChart(chart, batteryData) {
        const stateOfCharge = batteryData[0];
        chart.data.datasets[0].data = [
          stateOfCharge * 100,
          100 - stateOfCharge * 100,
        ];
        chart.update();
      }

      function fetchDataAndUpdateCharts() {
        for (let i = 0; i < chartCount; i++) {
          fetch(`/battery/${i}`)
            .then((response) => response.json())
            .then((data) => {
              updateChart(charts[i], data);
            })
            .catch((error) =>
              console.error("Error fetching battery state:", error)
            );
        }
      }

      setInterval(fetchDataAndUpdateCharts, 100); // 1분마다 업데이트

      // Initial chart update
      fetchDataAndUpdateCharts();
    </script>
  </body>
</html>
